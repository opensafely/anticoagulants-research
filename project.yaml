version: "3.0"

expectations:
  population_size: 1000

actions:
  generate_cohort:
    run: cohortextractor:latest generate_cohort 
    outputs:
      highly_sensitive:
        cohort1: output/input_af.csv
        cohort2: output/input_af_population_flow_chart.csv
        cohort3: output/input_general_population.csv
        cohort4: output/input_general_population_flow_chart.csv

  # Main Analysis 1
  # Objective 1: compare AF treated people with AF non-treated people
  format_dataset:
    run: stata-mp:latest analysis/00_cr_create_analysis_dataset.do af_oac
    needs: [generate_cohort]
    outputs:
      moderately_sensitive:
        log: oac_log/00_cr_create_analysis_dataset.log

  create_dataset:
    run: stata-mp:latest analysis/01_cr_create_exposure_outcome_af.do af_oac
    needs: [generate_cohort, format_dataset]
    outputs:
      moderately_sensitive:
        log: oac_log/01_cr_create_exposure_outcome_af.log
      highly_sensitive:
        data: "oac_tempdata/cr_dataset_af.dta"

  # Primary Outcomes: ONS COVID-19 death
  02a_cr_create_population_af_oac_onscoviddeath:
    run: stata-mp:latest analysis/02a_cr_create_population.do onscoviddeath af_oac
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: oac_log/02a_cr_create_population_onscoviddeath.log
      highly_sensitive:
        data1: "output/input_af_oac.csv"
        data2: "oac_tempdata/analysis_dataset_onscoviddeath.dta"
        data3: "oac_tempdata/analysis_dataset_STSET_onscoviddeath.dta"

  03_an_checks_af_oac_onscoviddeath:
    run: stata-mp:latest analysis/03_an_checks.do onscoviddeath af_oac
    needs: [02a_cr_create_population_af_oac_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_log/03_an_checks_onscoviddeath.log
  
  04_an_descriptive_table_af_oac_onscoviddeath:
    run: stata-mp:latest analysis/04_an_descriptive_table.do onscoviddeath af_oac
    needs: [02a_cr_create_population_af_oac_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_log/04_an_descriptive_table_onscoviddeath.log

  05a_an_models_af_oac_onscoviddeath:
    run: stata-mp:latest analysis/05a_an_models.do onscoviddeath af_oac
    needs: [02a_cr_create_population_af_oac_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_log/05a_an_models_onscoviddeath.log
        table: "oac_tabfig/table2_onscoviddeath.txt"
      highly_sensitive:
        data1: "oac_tempdata/univar.ster"
        data2: "oac_tempdata/multi1.ster"
        data3: "oac_tempdata/multi2.ster"
        data4: "oac_tempdata/multi3.ster"

  06a_an_models_ethnicity_af_oac_onscoviddeath:
    run: stata-mp:latest analysis/06a_an_models_ethnicity.do onscoviddeath af_oac
    needs: [02a_cr_create_population_af_oac_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_log/06a_an_models_ethnicity_onscoviddeath.log
        table: "oac_tabfig/table3_onscoviddeath.txt"
      highly_sensitive:
        data1: "oac_tempdata/univar_ethn.ster"
        data2: "oac_tempdata/multivar1_ethn.ster"
        data3: "oac_tempdata/multivar2_ethn.ster"
        data4: "oac_tempdata/multivar2_withoutethn.ster"
        data5: "oac_tempdata/multivar3_ethn.ster"
        data6: "oac_tempdata/multivar3_withoutethn.ster"

  07_an_model_exploration_af_oac_onscoviddeath:
    run: stata-mp:latest analysis/07_an_model_exploration.do onscoviddeath af_oac
    needs: [02a_cr_create_population_af_oac_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_log/07_an_model_exploration_onscoviddeath.log
        table: "oac_tabfig/table4_onscoviddeath.txt"

  08a_an_model_checks_af_oac_onscoviddeath:
    run: stata-mp:latest analysis/08a_an_model_checks.do onscoviddeath af_oac
    needs: [02a_cr_create_population_af_oac_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_log/08a_an_model_checks_onscoviddeath.log
        fig1: "oac_tabfig/schoenplot1.svg"
        fig2: "oac_tabfig/schoenplot2.svg"
        fig3: "oac_tabfig/schoenplot3.svg"
        fig4: "oac_tabfig/schoenplot4.svg"
        table1: "oac_tabfig/table5_onscoviddeath.txt"
        fig5: "oac_tabfig/schoenplot1_completecase.svg"
        fig6: "oac_tabfig/schoenplot2_completecase.svg"
        fig7: "oac_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "oac_tabfig/schoenplot3_completecase.svg"
        fig9: "oac_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "oac_tabfig/schoenplot4_completecase.svg"
        table2: "oac_tabfig/table6_onscoviddeath.txt"

  09a_an_models_plot_af_oac_onscoviddeath:
    run: stata-mp:latest analysis/09a_an_models_plot.do onscoviddeath af_oac
    needs: [02a_cr_create_population_af_oac_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_log/09a_an_models_plot_onscoviddeath.log
        fig1: "oac_tabfig/adj_curves_onscoviddeath.svg"
        fig2: "oac_tabfig/diff_curves_onscoviddeath.svg"

  # Primary Outcomes: COVID-19 hospital admission
  02a_cr_create_population_af_oac_admitcovid:
    run: stata-mp:latest analysis/02a_cr_create_population.do admitcovid af_oac
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: oac_log/02a_cr_create_population_admitcovid.log
      highly_sensitive:
        data1: "output/input_af_oac.csv"
        data2: "oac_tempdata/analysis_dataset_admitcovid.dta"
        data3: "oac_tempdata/analysis_dataset_STSET_admitcovid.dta"

  03_an_checks_af_oac_admitcovid:
    run: stata-mp:latest analysis/03_an_checks.do admitcovid af_oac
    needs: [02a_cr_create_population_af_oac_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_log/03_an_checks_admitcovid.log
  
  04_an_descriptive_table_af_oac_admitcovid:
    run: stata-mp:latest analysis/04_an_descriptive_table.do admitcovid af_oac
    needs: [02a_cr_create_population_af_oac_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_log/04_an_descriptive_table_admitcovid.log

  05a_an_models_af_oac_admitcovid:
    run: stata-mp:latest analysis/05a_an_models.do admitcovid af_oac
    needs: [02a_cr_create_population_af_oac_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_log/05a_an_models_admitcovid.log
        table: "oac_tabfig/table2_admitcovid.txt"
      highly_sensitive:
        data1: "oac_tempdata/univar.ster"
        data2: "oac_tempdata/multi1.ster"
        data3: "oac_tempdata/multi2.ster"
        data4: "oac_tempdata/multi3.ster"

  06a_an_models_ethnicity_af_oac_admitcovid:
    run: stata-mp:latest analysis/06a_an_models_ethnicity.do admitcovid af_oac
    needs: [02a_cr_create_population_af_oac_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_log/06a_an_models_ethnicity_admitcovid.log
        table: "oac_tabfig/table3_admitcovid.txt"
      highly_sensitive:
        data1: "oac_tempdata/univar_ethn.ster"
        data2: "oac_tempdata/multivar1_ethn.ster"
        data3: "oac_tempdata/multivar2_ethn.ster"
        data4: "oac_tempdata/multivar2_withoutethn.ster"
        data5: "oac_tempdata/multivar3_ethn.ster"
        data6: "oac_tempdata/multivar3_withoutethn.ster"

  07_an_model_exploration_af_oac_admitcovid:
    run: stata-mp:latest analysis/07_an_model_exploration.do admitcovid af_oac
    needs: [02a_cr_create_population_af_oac_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_log/07_an_model_exploration_admitcovid.log
        table: "oac_tabfig/table4_admitcovid.txt"

  08a_an_model_checks_af_oac_admitcovid:
    run: stata-mp:latest analysis/08a_an_model_checks.do admitcovid af_oac
    needs: [02a_cr_create_population_af_oac_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_log/08a_an_model_checks_admitcovid.log
        fig1: "oac_tabfig/schoenplot1.svg"
        fig2: "oac_tabfig/schoenplot2.svg"
        fig3: "oac_tabfig/schoenplot3.svg"
        fig4: "oac_tabfig/schoenplot4.svg"
        table1: "oac_tabfig/table5_admitcovid.txt"
        fig5: "oac_tabfig/schoenplot1_completecase.svg"
        fig6: "oac_tabfig/schoenplot2_completecase.svg"
        fig7: "oac_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "oac_tabfig/schoenplot3_completecase.svg"
        fig9: "oac_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "oac_tabfig/schoenplot4_completecase.svg"
        table2: "oac_tabfig/table6_admitcovid.txt"

  09a_an_models_plot_af_oac_admitcovid:
    run: stata-mp:latest analysis/09a_an_models_plot.do admitcovid af_oac
    needs: [02a_cr_create_population_af_oac_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_log/09a_an_models_plot_admitcovid.log
        fig1: "oac_tabfig/adj_curves_admitcovid.svg"
        fig2: "oac_tabfig/diff_curves_admitcovid.svg"

  # Exploratory Outcomes: COVID-19 test
  02a_cr_create_population_af_oac_covidtest:
    run: stata-mp:latest analysis/02a_cr_create_population.do covidtest af_oac
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: oac_log/02a_cr_create_population_covidtest.log
      highly_sensitive:
        data1: "output/input_af_oac.csv"
        data2: "oac_tempdata/analysis_dataset_covidtest.dta"
        data3: "oac_tempdata/analysis_dataset_STSET_covidtest.dta"

  03_an_checks_af_oac_covidtest:
    run: stata-mp:latest analysis/03_an_checks.do covidtest af_oac
    needs: [02a_cr_create_population_af_oac_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/03_an_checks_covidtest.log
  
  04_an_descriptive_table_af_oac_covidtest:
    run: stata-mp:latest analysis/04_an_descriptive_table.do covidtest af_oac
    needs: [02a_cr_create_population_af_oac_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/04_an_descriptive_table_covidtest.log

  05a_an_models_af_oac_covidtest:
    run: stata-mp:latest analysis/05a_an_models.do covidtest af_oac
    needs: [02a_cr_create_population_af_oac_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/05a_an_models_covidtest.log
        table: "oac_tabfig/table2_covidtest.txt"
      highly_sensitive:
        data1: "oac_tempdata/univar.ster"
        data2: "oac_tempdata/multi1.ster"
        data3: "oac_tempdata/multi2.ster"
        data4: "oac_tempdata/multi3.ster"

  06a_an_models_ethnicity_af_oac_covidtest:
    run: stata-mp:latest analysis/06a_an_models_ethnicity.do covidtest af_oac
    needs: [02a_cr_create_population_af_oac_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/06a_an_models_ethnicity_covidtest.log
        table: "oac_tabfig/table3_covidtest.txt"
      highly_sensitive:
        data1: "oac_tempdata/univar_ethn.ster"
        data2: "oac_tempdata/multivar1_ethn.ster"
        data3: "oac_tempdata/multivar2_ethn.ster"
        data4: "oac_tempdata/multivar2_withoutethn.ster"
        data5: "oac_tempdata/multivar3_ethn.ster"
        data6: "oac_tempdata/multivar3_withoutethn.ster"

  08a_an_model_checks_af_oac_covidtest:
    run: stata-mp:latest analysis/08a_an_model_checks.do covidtest af_oac
    needs: [02a_cr_create_population_af_oac_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/08a_an_model_checks_covidtest.log
        fig1: "oac_tabfig/schoenplot1.svg"
        fig2: "oac_tabfig/schoenplot2.svg"
        fig3: "oac_tabfig/schoenplot3.svg"
        fig4: "oac_tabfig/schoenplot4.svg"
        table1: "oac_tabfig/table5_covidtest.txt"
        fig5: "oac_tabfig/schoenplot1_completecase.svg"
        fig6: "oac_tabfig/schoenplot2_completecase.svg"
        fig7: "oac_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "oac_tabfig/schoenplot3_completecase.svg"
        fig9: "oac_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "oac_tabfig/schoenplot4_completecase.svg"
        table2: "oac_tabfig/table6_covidtest.txt"

  09a_an_models_plot_af_oac_covidtest:
    run: stata-mp:latest analysis/09a_an_models_plot.do covidtest af_oac
    needs: [02a_cr_create_population_af_oac_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/09a_an_models_plot_covidtest.log
        fig1: "oac_tabfig/adj_curves_covidtest.svg"
        fig2: "oac_tabfig/diff_curves_covidtest.svg"

  # Exploratory Outcomes: Positive COVID test
  02a_cr_create_population_af_oac_positivecovidtest:
    run: stata-mp:latest analysis/02a_cr_create_population.do positivecovidtest af_oac
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: oac_log/02a_cr_create_population_positivecovidtest.log
      highly_sensitive:
        data1: "output/input_af_oac.csv"
        data2: "oac_tempdata/analysis_dataset_positivecovidtest.dta"
        data3: "oac_tempdata/analysis_dataset_STSET_positivecovidtest.dta"

  03_an_checks_af_oac_positivecovidtest:
    run: stata-mp:latest analysis/03_an_checks.do positivecovidtest af_oac
    needs: [02a_cr_create_population_af_oac_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/03_an_checks_positivecovidtest.log
  
  04_an_descriptive_table_af_oac_positivecovidtest:
    run: stata-mp:latest analysis/04_an_descriptive_table.do positivecovidtest af_oac
    needs: [02a_cr_create_population_af_oac_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/04_an_descriptive_table_positivecovidtest.log

  05a_an_models_af_oac_positivecovidtest:
    run: stata-mp:latest analysis/05a_an_models.do positivecovidtest af_oac
    needs: [02a_cr_create_population_af_oac_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/05a_an_models_positivecovidtest.log
        table: "oac_tabfig/table2_positivecovidtest.txt"
      highly_sensitive:
        data1: "oac_tempdata/univar.ster"
        data2: "oac_tempdata/multi1.ster"
        data3: "oac_tempdata/multi2.ster"
        data4: "oac_tempdata/multi3.ster"

  06a_an_models_ethnicity_af_oac_positivecovidtest:
    run: stata-mp:latest analysis/06a_an_models_ethnicity.do positivecovidtest af_oac
    needs: [02a_cr_create_population_af_oac_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/06a_an_models_ethnicity_positivecovidtest.log
        table: "oac_tabfig/table3_positivecovidtest.txt"
      highly_sensitive:
        data1: "oac_tempdata/univar_ethn.ster"
        data2: "oac_tempdata/multivar1_ethn.ster"
        data3: "oac_tempdata/multivar2_ethn.ster"
        data4: "oac_tempdata/multivar2_withoutethn.ster"
        data5: "oac_tempdata/multivar3_ethn.ster"
        data6: "oac_tempdata/multivar3_withoutethn.ster"

  08a_an_model_checks_af_oac_positivecovidtest:
    run: stata-mp:latest analysis/08a_an_model_checks.do positivecovidtest af_oac
    needs: [02a_cr_create_population_af_oac_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/08a_an_model_checks_positivecovidtest.log
        fig1: "oac_tabfig/schoenplot1.svg"
        fig2: "oac_tabfig/schoenplot2.svg"
        fig3: "oac_tabfig/schoenplot3.svg"
        fig4: "oac_tabfig/schoenplot4.svg"
        table1: "oac_tabfig/table5_positivecovidtest.txt"
        fig5: "oac_tabfig/schoenplot1_completecase.svg"
        fig6: "oac_tabfig/schoenplot2_completecase.svg"
        fig7: "oac_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "oac_tabfig/schoenplot3_completecase.svg"
        fig9: "oac_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "oac_tabfig/schoenplot4_completecase.svg"
        table2: "oac_tabfig/table6_positivecovidtest.txt"

  09a_an_models_plot_af_oac_positivecovidtest:
    run: stata-mp:latest analysis/09a_an_models_plot.do positivecovidtest af_oac
    needs: [02a_cr_create_population_af_oac_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_log/09a_an_models_plot_positivecovidtest.log
        fig1: "oac_tabfig/adj_curves_positivecovidtest.svg"
        fig2: "oac_tabfig/diff_curves_positivecovidtest.svg"

  # Main Analysis 2
  # Objective 2: Compare warfarin users and DOAC users
  format_dataset:
    run: stata-mp:latest analysis/00_cr_create_analysis_dataset.do af_warfarin
    needs: [generate_cohort]
    outputs:
      moderately_sensitive:
        log: warfarin_log/00_cr_create_analysis_dataset.log

  create_dataset:
    run: stata-mp:latest analysis/01_cr_create_exposure_outcome_af.do af_warfarin
    needs: [generate_cohort, format_dataset]
    outputs:
      moderately_sensitive:
        log: warfarin_log/01_cr_create_exposure_outcome_af.log
      highly_sensitive:
        data: "warfarin_tempdata/cr_dataset_af.dta"

  # Primary Outcomes: ONS COVID-19 death
  02b_cr_create_population_af_warfarin_onscoviddeath:
    run: stata-mp:latest analysis/02b_cr_create_population.do onscoviddeath af_warfarin
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: warfarin_log/02b_cr_create_population_onscoviddeath.log
      highly_sensitive:
        data1: "warfarin_tempdata/analysis_dataset_onscoviddeath.dta"
        data2: "warfarin_tempdata/analysis_dataset_STSET_onscoviddeath.dta"

  03_an_checks_af_warfarin_onscoviddeath:
    run: stata-mp:latest analysis/03_an_checks.do onscoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/03_an_checks_onscoviddeath.log
  
  04_an_descriptive_table_af_warfarin_onscoviddeath:
    run: stata-mp:latest analysis/04_an_descriptive_table.do onscoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/04_an_descriptive_table_onscoviddeath.log

  05b_an_models_af_warfarin_onscoviddeath:
    run: stata-mp:latest analysis/05b_an_models.do onscoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/05b_an_models_onscoviddeath.log
        table: "warfarin_tabfig/table2_onscoviddeath.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar.ster"
        data2: "warfarin_tempdata/multi1.ster"
        data3: "warfarin_tempdata/multi2.ster"
        data4: "warfarin_tempdata/multi3.ster"

  06b_an_models_ethnicity_af_warfarin_onscoviddeath:
    run: stata-mp:latest analysis/06b_an_models_ethnicity.do onscoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/06b_an_models_ethnicity_onscoviddeath.log
        table: "warfarin_tabfig/table3_onscoviddeath.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar_ethn.ster"
        data2: "warfarin_tempdata/multivar1_ethn.ster"
        data3: "warfarin_tempdata/multivar2_ethn.ster"
        data4: "warfarin_tempdata/multivar2_withoutethn.ster"
        data5: "warfarin_tempdata/multivar3_ethn.ster"
        data6: "warfarin_tempdata/multivar3_withoutethn.ster"

  07_an_model_exploration_af_warfarin_onscoviddeath:
    run: stata-mp:latest analysis/07_an_model_exploration.do onscoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/07_an_model_exploration_onscoviddeath.log
        table: "warfarin_tabfig/table4_onscoviddeath.txt"

  08b_an_model_checks_af_warfarin_onscoviddeath:
    run: stata-mp:latest analysis/08b_an_model_checks.do onscoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/08b_an_model_checks_onscoviddeath.log
        fig1: "warfarin_tabfig/schoenplot1.svg"
        fig2: "warfarin_tabfig/schoenplot2.svg"
        fig3: "warfarin_tabfig/schoenplot3.svg"
        fig4: "warfarin_tabfig/schoenplot4.svg"
        table1: "warfarin_tabfig/table5_onscoviddeath.txt"
        fig5: "warfarin_tabfig/schoenplot1_completecase.svg"
        fig6: "warfarin_tabfig/schoenplot2_completecase.svg"
        fig7: "warfarin_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "warfarin_tabfig/schoenplot3_completecase.svg"
        fig9: "warfarin_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "warfarin_tabfig/schoenplot4_completecase.svg"
        table2: "warfarin_tabfig/table6_onscoviddeath.txt"

  09b_an_models_plot_af_warfarin_onscoviddeath:
    run: stata-mp:latest analysis/09b_an_models_plot.do onscoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/09b_an_models_plot_onscoviddeath.log
        fig1: "warfarin_tabfig/adj_curves_onscoviddeath.svg"
        fig2: "warfarin_tabfig/diff_curves_onscoviddeath.svg"

  # Primary Outcomes: COVID-19 hospital admission
  02b_cr_create_population_af_warfarin_admitcovid:
    run: stata-mp:latest analysis/02b_cr_create_population.do admitcovid af_warfarin
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: warfarin_log/02b_cr_create_population_admitcovid.log
      highly_sensitive:
        data1: "warfarin_tempdata/analysis_dataset_admitcovid.dta"
        data2: "warfarin_tempdata/analysis_dataset_STSET_admitcovid.dta"

  03_an_checks_af_warfarin_admitcovid:
    run: stata-mp:latest analysis/03_an_checks.do admitcovid af_warfarin
    needs: [02b_cr_create_population_af_warfarin_admitcovid]
    outputs:
      moderately_sensitive:
        log: warfarin_log/03_an_checks_admitcovid.log
  
  04_an_descriptive_table_af_warfarin_admitcovid:
    run: stata-mp:latest analysis/04_an_descriptive_table.do admitcovid af_warfarin
    needs: [02b_cr_create_population_af_warfarin_admitcovid]
    outputs:
      moderately_sensitive:
        log: warfarin_log/04_an_descriptive_table_admitcovid.log

  05b_an_models_af_warfarin_admitcovid:
    run: stata-mp:latest analysis/05b_an_models.do admitcovid af_warfarin
    needs: [02b_cr_create_population_af_warfarin_admitcovid]
    outputs:
      moderately_sensitive:
        log: warfarin_log/05b_an_models_admitcovid.log
        table: "warfarin_tabfig/table2_admitcovid.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar.ster"
        data2: "warfarin_tempdata/multi1.ster"
        data3: "warfarin_tempdata/multi2.ster"
        data4: "warfarin_tempdata/multi3.ster"

  06b_an_models_ethnicity_af_warfarin_admitcovid:
    run: stata-mp:latest analysis/06b_an_models_ethnicity.do admitcovid af_warfarin
    needs: [02b_cr_create_population_af_warfarin_admitcovid]
    outputs:
      moderately_sensitive:
        log: warfarin_log/06b_an_models_ethnicity_admitcovid.log
        table: "warfarin_tabfig/table3_admitcovid.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar_ethn.ster"
        data2: "warfarin_tempdata/multivar1_ethn.ster"
        data3: "warfarin_tempdata/multivar2_ethn.ster"
        data4: "warfarin_tempdata/multivar2_withoutethn.ster"
        data5: "warfarin_tempdata/multivar3_ethn.ster"
        data6: "warfarin_tempdata/multivar3_withoutethn.ster"

  07_an_model_exploration_af_warfarin_admitcovid:
    run: stata-mp:latest analysis/07_an_model_exploration.do admitcovid af_warfarin
    needs: [02b_cr_create_population_af_warfarin_admitcovid]
    outputs:
      moderately_sensitive:
        log: warfarin_log/07_an_model_exploration_admitcovid.log
        table: "warfarin_tabfig/table4_admitcovid.txt"

  08b_an_model_checks_af_warfarin_admitcovid:
    run: stata-mp:latest analysis/08b_an_model_checks.do admitcovid af_warfarin
    needs: [02b_cr_create_population_af_warfarin_admitcovid]
    outputs:
      moderately_sensitive:
        log: warfarin_log/08b_an_model_checks_admitcovid.log
        fig1: "warfarin_tabfig/schoenplot1.svg"
        fig2: "warfarin_tabfig/schoenplot2.svg"
        fig3: "warfarin_tabfig/schoenplot3.svg"
        fig4: "warfarin_tabfig/schoenplot4.svg"
        table1: "warfarin_tabfig/table5_admitcovid.txt"
        fig5: "warfarin_tabfig/schoenplot1_completecase.svg"
        fig6: "warfarin_tabfig/schoenplot2_completecase.svg"
        fig7: "warfarin_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "warfarin_tabfig/schoenplot3_completecase.svg"
        fig9: "warfarin_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "warfarin_tabfig/schoenplot4_completecase.svg"
        table2: "warfarin_tabfig/table6_admitcovid.txt"

  09b_an_models_plot_af_warfarin_admitcovid:
    run: stata-mp:latest analysis/09b_an_models_plot.do admitcovid af_warfarin
    needs: [02b_cr_create_population_af_warfarin_admitcovid]
    outputs:
      moderately_sensitive:
        log: warfarin_log/09b_an_models_plot_admitcovid.log
        fig1: "warfarin_tabfig/adj_curves_admitcovid.svg"
        fig2: "warfarin_tabfig/diff_curves_admitcovid.svg"

    # Exploratory Outcomes: Non-COVID death
  02b_cr_create_population_af_warfarin_onsnoncoviddeath:
    run: stata-mp:latest analysis/02b_cr_create_population.do onsnoncoviddeath af_warfarin
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: warfarin_log/02b_cr_create_population_onsnoncoviddeath.log
      highly_sensitive:
        data1: "warfarin_tempdata/analysis_dataset_onsnoncoviddeath.dta"
        data2: "warfarin_tempdata/analysis_dataset_STSET_onsnoncoviddeath.dta"

  03_an_checks_af_warfarin_onsnoncoviddeath:
    run: stata-mp:latest analysis/03_an_checks.do onsnoncoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onsnoncoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/03_an_checks_onsnoncoviddeath.log
  
  04_an_descriptive_table_af_warfarin_onsnoncoviddeath:
    run: stata-mp:latest analysis/04_an_descriptive_table.do onsnoncoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onsnoncoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/04_an_descriptive_table_onsnoncoviddeath.log

  05b_an_models_af_warfarin_onsnoncoviddeath:
    run: stata-mp:latest analysis/05b_an_models.do onsnoncoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onsnoncoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/05b_an_models_onsnoncoviddeath.log
        table: "warfarin_tabfig/table2_onsnoncoviddeath.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar.ster"
        data2: "warfarin_tempdata/multi1.ster"
        data3: "warfarin_tempdata/multi2.ster"
        data4: "warfarin_tempdata/multi3.ster"

  06b_an_models_ethnicity_af_warfarin_onsnoncoviddeath:
    run: stata-mp:latest analysis/06b_an_models_ethnicity.do onsnoncoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onsnoncoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/06b_an_models_ethnicity_onsnoncoviddeath.log
        table: "warfarin_tabfig/table3_onsnoncoviddeath.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar_ethn.ster"
        data2: "warfarin_tempdata/multivar1_ethn.ster"
        data3: "warfarin_tempdata/multivar2_ethn.ster"
        data4: "warfarin_tempdata/multivar2_withoutethn.ster"
        data5: "warfarin_tempdata/multivar3_ethn.ster"
        data6: "warfarin_tempdata/multivar3_withoutethn.ster"

  08b_an_model_checks_af_warfarin_onsnoncoviddeath:
    run: stata-mp:latest analysis/08b_an_model_checks.do onsnoncoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onsnoncoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/08b_an_model_checks_onsnoncoviddeath.log
        fig1: "warfarin_tabfig/schoenplot1.svg"
        fig2: "warfarin_tabfig/schoenplot2.svg"
        fig3: "warfarin_tabfig/schoenplot3.svg"
        fig4: "warfarin_tabfig/schoenplot4.svg"
        table1: "warfarin_tabfig/table5_onsnoncoviddeath.txt"
        fig5: "warfarin_tabfig/schoenplot1_completecase.svg"
        fig6: "warfarin_tabfig/schoenplot2_completecase.svg"
        fig7: "warfarin_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "warfarin_tabfig/schoenplot3_completecase.svg"
        fig9: "warfarin_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "warfarin_tabfig/schoenplot4_completecase.svg"
        table2: "warfarin_tabfig/table6_onsnoncoviddeath.txt"

  09b_an_models_plot_af_warfarin_onsnoncoviddeath:
    run: stata-mp:latest analysis/09b_an_models_plot.do onsnoncoviddeath af_warfarin
    needs: [02b_cr_create_population_af_warfarin_onsnoncoviddeath]
    outputs:
      moderately_sensitive:
        log: warfarin_log/09b_an_models_plot_onsnoncoviddeath.log
        fig1: "warfarin_tabfig/adj_curves_onsnoncoviddeath.svg"
        fig2: "warfarin_tabfig/diff_curves_onsnoncoviddeath.svg"
        
  # Exploratory Outcomes: COVID-19 test
  02b_cr_create_population_af_warfarin_covidtest:
    run: stata-mp:latest analysis/02b_cr_create_population.do covidtest af_warfarin
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: warfarin_log/02b_cr_create_population_covidtest.log
      highly_sensitive:
        data1: "warfarin_tempdata/analysis_dataset_covidtest.dta"
        data2: "warfarin_tempdata/analysis_dataset_STSET_covidtest.dta"

  03_an_checks_af_warfarin_covidtest:
    run: stata-mp:latest analysis/03_an_checks.do covidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_covidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/03_an_checks_covidtest.log
  
  04_an_descriptive_table_af_warfarin_covidtest:
    run: stata-mp:latest analysis/04_an_descriptive_table.do covidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_covidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/04_an_descriptive_table_covidtest.log

  05b_an_models_af_warfarin_covidtest:
    run: stata-mp:latest analysis/05b_an_models.do covidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_covidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/05b_an_models_covidtest.log
        table: "warfarin_tabfig/table2_covidtest.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar.ster"
        data2: "warfarin_tempdata/multi1.ster"
        data3: "warfarin_tempdata/multi2.ster"
        data4: "warfarin_tempdata/multi3.ster"

  06b_an_models_ethnicity_af_warfarin_covidtest:
    run: stata-mp:latest analysis/06b_an_models_ethnicity.do covidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_covidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/06b_an_models_ethnicity_covidtest.log
        table: "warfarin_tabfig/table3_covidtest.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar_ethn.ster"
        data2: "warfarin_tempdata/multivar1_ethn.ster"
        data3: "warfarin_tempdata/multivar2_ethn.ster"
        data4: "warfarin_tempdata/multivar2_withoutethn.ster"
        data5: "warfarin_tempdata/multivar3_ethn.ster"
        data6: "warfarin_tempdata/multivar3_withoutethn.ster"

  08b_an_model_checks_af_warfarin_covidtest:
    run: stata-mp:latest analysis/08b_an_model_checks.do covidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_covidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/08b_an_model_checks_covidtest.log
        fig1: "warfarin_tabfig/schoenplot1.svg"
        fig2: "warfarin_tabfig/schoenplot2.svg"
        fig3: "warfarin_tabfig/schoenplot3.svg"
        fig4: "warfarin_tabfig/schoenplot4.svg"
        table1: "warfarin_tabfig/table5_covidtest.txt"
        fig5: "warfarin_tabfig/schoenplot1_completecase.svg"
        fig6: "warfarin_tabfig/schoenplot2_completecase.svg"
        fig7: "warfarin_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "warfarin_tabfig/schoenplot3_completecase.svg"
        fig9: "warfarin_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "warfarin_tabfig/schoenplot4_completecase.svg"
        table2: "warfarin_tabfig/table6_covidtest.txt"

  09b_an_models_plot_af_warfarin_covidtest:
    run: stata-mp:latest analysis/09b_an_models_plot.do covidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_covidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/09b_an_models_plot_covidtest.log
        fig1: "warfarin_tabfig/adj_curves_covidtest.svg"
        fig2: "warfarin_tabfig/diff_curves_covidtest.svg"

  # Exploratory Outcomes: Positive COVID test
  02b_cr_create_population_af_warfarin_positivecovidtest:
    run: stata-mp:latest analysis/02b_cr_create_population.do positivecovidtest af_warfarin
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: warfarin_log/02b_cr_create_population_positivecovidtest.log
      highly_sensitive:
        data1: "warfarin_tempdata/analysis_dataset_positivecovidtest.dta"
        data2: "warfarin_tempdata/analysis_dataset_STSET_positivecovidtest.dta"

  03_an_checks_af_warfarin_positivecovidtest:
    run: stata-mp:latest analysis/03_an_checks.do positivecovidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/03_an_checks_positivecovidtest.log
  
  04_an_descriptive_table_af_warfarin_positivecovidtest:
    run: stata-mp:latest analysis/04_an_descriptive_table.do positivecovidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/04_an_descriptive_table_positivecovidtest.log

  05b_an_models_af_warfarin_positivecovidtest:
    run: stata-mp:latest analysis/05b_an_models.do positivecovidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/05b_an_models_positivecovidtest.log
        table: "warfarin_tabfig/table2_positivecovidtest.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar.ster"
        data2: "warfarin_tempdata/multi1.ster"
        data3: "warfarin_tempdata/multi2.ster"
        data4: "warfarin_tempdata/multi3.ster"

  06b_an_models_ethnicity_af_warfarin_positivecovidtest:
    run: stata-mp:latest analysis/06b_an_models_ethnicity.do positivecovidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/06b_an_models_ethnicity_positivecovidtest.log
        table: "warfarin_tabfig/table3_positivecovidtest.txt"
      highly_sensitive:
        data1: "warfarin_tempdata/univar_ethn.ster"
        data2: "warfarin_tempdata/multivar1_ethn.ster"
        data3: "warfarin_tempdata/multivar2_ethn.ster"
        data4: "warfarin_tempdata/multivar2_withoutethn.ster"
        data5: "warfarin_tempdata/multivar3_ethn.ster"
        data6: "warfarin_tempdata/multivar3_withoutethn.ster"

  08b_an_model_checks_af_warfarin_positivecovidtest:
    run: stata-mp:latest analysis/08b_an_model_checks.do positivecovidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/08b_an_model_checks_positivecovidtest.log
        fig1: "warfarin_tabfig/schoenplot1.svg"
        fig2: "warfarin_tabfig/schoenplot2.svg"
        fig3: "warfarin_tabfig/schoenplot3.svg"
        fig4: "warfarin_tabfig/schoenplot4.svg"
        table1: "warfarin_tabfig/table5_positivecovidtest.txt"
        fig5: "warfarin_tabfig/schoenplot1_completecase.svg"
        fig6: "warfarin_tabfig/schoenplot2_completecase.svg"
        fig7: "warfarin_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "warfarin_tabfig/schoenplot3_completecase.svg"
        fig9: "warfarin_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "warfarin_tabfig/schoenplot4_completecase.svg"
        table2: "warfarin_tabfig/table6_positivecovidtest.txt"

  09b_an_models_plot_af_warfarin_positivecovidtest:
    run: stata-mp:latest analysis/09b_an_models_plot.do positivecovidtest af_warfarin
    needs: [02b_cr_create_population_af_warfarin_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: warfarin_log/09b_an_models_plot_positivecovidtest.log
        fig1: "warfarin_tabfig/adj_curves_positivecovidtest.svg"
        fig2: "warfarin_tabfig/diff_curves_positivecovidtest.svg"

# Main Analysis 3
# Objective 1: compare AF treated people with general population

  matching:
    run: python:latest python analysis/match_running.py
    needs: [generate_cohort, 02a_cr_create_population_af_oac_onscoviddeath]
    outputs:
      highly_sensitive:
        data1: "oac_match_tempdata/af_oac_only_matched_to_general_population.csv"
        data2: "oac_match_tempdata/general_population_matched_only.csv"
        data3: "oac_match_tempdata/af_oac_matched_to_general_population.csv"

  format_dataset:
    run: stata-mp:latest analysis/00_cr_create_analysis_dataset.do af_match
    needs: [generate_cohort, matching]
    outputs:
      moderately_sensitive:
        log: oac_match_log/00_cr_create_analysis_dataset.log

  create_dataset:
    run: stata-mp:latest analysis/01_cr_create_exposure_outcome_af.do af_match
    needs: [format_dataset]
    outputs:
      moderately_sensitive:
        log: oac_match_log/01_cr_create_exposure_outcome_af.log
      highly_sensitive:
        data: "oac_match_tempdata/cr_dataset_af.dta"

  # Primary Outcomes: ONS COVID-19 death
  02c_cr_create_population_af_match_onscoviddeath:
    run: stata-mp:latest analysis/02c_cr_create_population.do onscoviddeath af_match
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: oac_match_log/02c_cr_create_population_onscoviddeath.log
      highly_sensitive:
        data1: "output/matched_control.dta"
        data2: "oac_match_tempdata/analysis_dataset_onscoviddeath.dta"
        data3: "oac_match_tempdata/analysis_dataset_STSET_onscoviddeath.dta"

  03_an_checks_af_match_onscoviddeath:
    run: stata-mp:latest analysis/03_an_checks.do onscoviddeath af_match
    needs: [02c_cr_create_population_af_match_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_match_log/03_an_checks_onscoviddeath.log
  
  04_an_descriptive_table_af_match_onscoviddeath:
    run: stata-mp:latest analysis/04_an_descriptive_table.do onscoviddeath af_match
    needs: [02c_cr_create_population_af_match_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_match_log/04_an_descriptive_table_onscoviddeath.log

  05c_an_models_af_match_onscoviddeath:
    run: stata-mp:latest analysis/05c_an_models.do onscoviddeath af_match
    needs: [02c_cr_create_population_af_match_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_match_log/05c_an_models_onscoviddeath.log
        table: "oac_match_tabfig/table2_onscoviddeath.txt"
      highly_sensitive:
        data1: "oac_match_tempdata/univar.ster"
        data2: "oac_match_tempdata/multi1.ster"
        data3: "oac_match_tempdata/multi2.ster"
        data4: "oac_match_tempdata/multi3.ster"

  06c_an_models_ethnicity_af_match_onscoviddeath:
    run: stata-mp:latest analysis/06c_an_models_ethnicity.do onscoviddeath af_match
    needs: [02c_cr_create_population_af_match_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_match_log/06c_an_models_ethnicity_onscoviddeath.log
        table: "oac_match_tabfig/table3_onscoviddeath.txt"
      highly_sensitive:
        data1: "oac_match_tempdata/univar_ethn.ster"
        data2: "oac_match_tempdata/multivar1_ethn.ster"
        data3: "oac_match_tempdata/multivar2_ethn.ster"
        data4: "oac_match_tempdata/multivar2_withoutethn.ster"
        data5: "oac_match_tempdata/multivar3_ethn.ster"
        data6: "oac_match_tempdata/multivar3_withoutethn.ster"

  07_an_model_exploration_af_match_onscoviddeath:
    run: stata-mp:latest analysis/07_an_model_exploration.do onscoviddeath af_match
    needs: [02c_cr_create_population_af_match_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_match_log/07_an_model_exploration_onscoviddeath.log
        table: "oac_match_tabfig/table4_onscoviddeath.txt"

  08c_an_model_checks_af_match_onscoviddeath:
    run: stata-mp:latest analysis/08c_an_model_checks.do onscoviddeath af_match
    needs: [02c_cr_create_population_af_match_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_match_log/08c_an_model_checks_onscoviddeath.log
        fig1: "oac_match_tabfig/schoenplot1.svg"
        fig2: "oac_match_tabfig/schoenplot2.svg"
        fig3: "oac_match_tabfig/schoenplot3.svg"
        fig4: "oac_match_tabfig/schoenplot4.svg"
        table1: "oac_match_tabfig/table5_onscoviddeath.txt"
        fig5: "oac_match_tabfig/schoenplot1_completecase.svg"
        fig6: "oac_match_tabfig/schoenplot2_completecase.svg"
        fig7: "oac_match_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "oac_match_tabfig/schoenplot3_completecase.svg"
        fig9: "oac_match_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "oac_match_tabfig/schoenplot4_completecase.svg"
        table2: "oac_match_tabfig/table6_onscoviddeath.txt"

  09a_an_models_plot_af_match_onscoviddeath:
    run: stata-mp:latest analysis/09a_an_models_plot.do onscoviddeath af_match
    needs: [02c_cr_create_population_af_match_onscoviddeath]
    outputs:
      moderately_sensitive:
        log: oac_match_log/09a_an_models_plot_onscoviddeath.log
        fig1: "oac_match_tabfig/adj_curves_onscoviddeath.svg"
        fig2: "oac_match_tabfig/diff_curves_onscoviddeath.svg"

  # Primary Outcomes: COVID-19 hospital admission
  02c_cr_create_population_af_match_admitcovid:
    run: stata-mp:latest analysis/02c_cr_create_population.do admitcovid af_match
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: oac_match_log/02c_cr_create_population_admitcovid.log
      highly_sensitive:
        data1: "output/matched_control.dta"
        data2: "oac_match_tempdata/analysis_dataset_onscoviddeath.dta"
        data3: "oac_match_tempdata/analysis_dataset_STSET_onscoviddeath.dta"

  03_an_checks_af_match_admitcovid:
    run: stata-mp:latest analysis/03_an_checks.do admitcovid af_match
    needs: [02c_cr_create_population_af_match_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_match_log/03_an_checks_admitcovid.log
  
  04_an_descriptive_table_af_match_admitcovid:
    run: stata-mp:latest analysis/04_an_descriptive_table.do admitcovid af_match
    needs: [02c_cr_create_population_af_match_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_match_log/04_an_descriptive_table_admitcovid.log

  05c_an_models_af_match_admitcovid:
    run: stata-mp:latest analysis/05c_an_models.do admitcovid af_match
    needs: [02c_cr_create_population_af_match_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_match_log/05c_an_models_admitcovid.log
        table: "oac_match_tabfig/table2_admitcovid.txt"
      highly_sensitive:
        data1: "oac_match_tempdata/univar.ster"
        data2: "oac_match_tempdata/multi1.ster"
        data3: "oac_match_tempdata/multi2.ster"
        data4: "oac_match_tempdata/multi3.ster"

  06c_an_models_ethnicity_af_match_admitcovid:
    run: stata-mp:latest analysis/06c_an_models_ethnicity.do admitcovid af_match
    needs: [02c_cr_create_population_af_match_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_match_log/06c_an_models_ethnicity_admitcovid.log
        table: "oac_match_tabfig/table3_admitcovid.txt"
      highly_sensitive:
        data1: "oac_match_tempdata/univar_ethn.ster"
        data2: "oac_match_tempdata/multivar1_ethn.ster"
        data3: "oac_match_tempdata/multivar2_ethn.ster"
        data4: "oac_match_tempdata/multivar2_withoutethn.ster"
        data5: "oac_match_tempdata/multivar3_ethn.ster"
        data6: "oac_match_tempdata/multivar3_withoutethn.ster"

  07_an_model_exploration_af_match_admitcovid:
    run: stata-mp:latest analysis/07_an_model_exploration.do admitcovid af_match
    needs: [02c_cr_create_population_af_match_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_match_log/07_an_model_exploration_admitcovid.log
        table: "oac_match_tabfig/table4_admitcovid.txt"

  08c_an_model_checks_af_match_admitcovid:
    run: stata-mp:latest analysis/08c_an_model_checks.do admitcovid af_match
    needs: [02c_cr_create_population_af_match_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_match_log/08c_an_model_checks_admitcovid.log
        fig1: "oac_match_tabfig/schoenplot1.svg"
        fig2: "oac_match_tabfig/schoenplot2.svg"
        fig3: "oac_match_tabfig/schoenplot3.svg"
        fig4: "oac_match_tabfig/schoenplot4.svg"
        table1: "oac_match_tabfig/table5_admitcovid.txt"
        fig5: "oac_match_tabfig/schoenplot1_completecase.svg"
        fig6: "oac_match_tabfig/schoenplot2_completecase.svg"
        fig7: "oac_match_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "oac_match_tabfig/schoenplot3_completecase.svg"
        fig9: "oac_match_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "oac_match_tabfig/schoenplot4_completecase.svg"
        table2: "oac_match_tabfig/table6_admitcovid.txt"

  09a_an_models_plot_af_match_admitcovid:
    run: stata-mp:latest analysis/09a_an_models_plot.do admitcovid af_match
    needs: [02c_cr_create_population_af_match_admitcovid]
    outputs:
      moderately_sensitive:
        log: oac_match_log/09a_an_models_plot_admitcovid.log
        fig1: "oac_match_tabfig/adj_curves_admitcovid.svg"
        fig2: "oac_match_tabfig/diff_curves_admitcovid.svg"

  # Exploratory Outcomes: COVID-19 test
  02c_cr_create_population_af_match_covidtest:
    run: stata-mp:latest analysis/02c_cr_create_population.do covidtest af_match
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: oac_match_log/02c_cr_create_population_covidtest.log
      highly_sensitive:
        data1: "output/matched_control.dta"
        data2: "oac_match_tempdata/analysis_dataset_onscoviddeath.dta"
        data3: "oac_match_tempdata/analysis_dataset_STSET_onscoviddeath.dta"

  03_an_checks_af_match_covidtest:
    run: stata-mp:latest analysis/03_an_checks.do covidtest af_match
    needs: [02c_cr_create_population_af_match_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/03_an_checks_covidtest.log
  
  04_an_descriptive_table_af_match_covidtest:
    run: stata-mp:latest analysis/04_an_descriptive_table.do covidtest af_match
    needs: [02c_cr_create_population_af_match_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/04_an_descriptive_table_covidtest.log

  05c_an_models_af_match_covidtest:
    run: stata-mp:latest analysis/05c_an_models.do covidtest af_match
    needs: [02c_cr_create_population_af_match_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/05c_an_models_covidtest.log
        table: "oac_match_tabfig/table2_covidtest.txt"
      highly_sensitive:
        data1: "oac_match_tempdata/univar.ster"
        data2: "oac_match_tempdata/multi1.ster"
        data3: "oac_match_tempdata/multi2.ster"
        data4: "oac_match_tempdata/multi3.ster"

  06c_an_models_ethnicity_af_match_covidtest:
    run: stata-mp:latest analysis/06c_an_models_ethnicity.do covidtest af_match
    needs: [02c_cr_create_population_af_match_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/06c_an_models_ethnicity_covidtest.log
        table: "oac_match_tabfig/table3_covidtest.txt"
      highly_sensitive:
        data1: "oac_match_tempdata/univar_ethn.ster"
        data2: "oac_match_tempdata/multivar1_ethn.ster"
        data3: "oac_match_tempdata/multivar2_ethn.ster"
        data4: "oac_match_tempdata/multivar2_withoutethn.ster"
        data5: "oac_match_tempdata/multivar3_ethn.ster"
        data6: "oac_match_tempdata/multivar3_withoutethn.ster"

  08c_an_model_checks_af_match_covidtest:
    run: stata-mp:latest analysis/08c_an_model_checks.do covidtest af_match
    needs: [02c_cr_create_population_af_match_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/08c_an_model_checks_covidtest.log
        fig1: "oac_match_tabfig/schoenplot1.svg"
        fig2: "oac_match_tabfig/schoenplot2.svg"
        fig3: "oac_match_tabfig/schoenplot3.svg"
        fig4: "oac_match_tabfig/schoenplot4.svg"
        table1: "oac_match_tabfig/table5_covidtest.txt"
        fig5: "oac_match_tabfig/schoenplot1_completecase.svg"
        fig6: "oac_match_tabfig/schoenplot2_completecase.svg"
        fig7: "oac_match_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "oac_match_tabfig/schoenplot3_completecase.svg"
        fig9: "oac_match_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "oac_match_tabfig/schoenplot4_completecase.svg"
        table2: "oac_match_tabfig/table6_covidtest.txt"

  09a_an_models_plot_af_match_covidtest:
    run: stata-mp:latest analysis/09a_an_models_plot.do covidtest af_match
    needs: [02c_cr_create_population_af_match_covidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/09a_an_models_plot_covidtest.log
        fig1: "oac_match_tabfig/adj_curves_covidtest.svg"
        fig2: "oac_match_tabfig/diff_curves_covidtest.svg"

  # Exploratory Outcomes: Positive COVID test
  02c_cr_create_population_af_match_positivecovidtest:
    run: stata-mp:latest analysis/02c_cr_create_population.do positivecovidtest af_match
    needs: [create_dataset]
    outputs:
      moderately_sensitive:
        log: oac_match_log/02c_cr_create_population_positivecovidtest.log
      highly_sensitive:
        data1: "output/matched_control.dta"
        data2: "oac_match_tempdata/analysis_dataset_onscoviddeath.dta"
        data3: "oac_match_tempdata/analysis_dataset_STSET_onscoviddeath.dta"

  03_an_checks_af_match_positivecovidtest:
    run: stata-mp:latest analysis/03_an_checks.do positivecovidtest af_match
    needs: [02c_cr_create_population_af_match_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/03_an_checks_positivecovidtest.log
  
  04_an_descriptive_table_af_match_positivecovidtest:
    run: stata-mp:latest analysis/04_an_descriptive_table.do positivecovidtest af_match
    needs: [02c_cr_create_population_af_match_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/04_an_descriptive_table_positivecovidtest.log

  05c_an_models_af_match_positivecovidtest:
    run: stata-mp:latest analysis/05c_an_models.do positivecovidtest af_match
    needs: [02c_cr_create_population_af_match_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/05c_an_models_positivecovidtest.log
        table: "oac_match_tabfig/table2_positivecovidtest.txt"
      highly_sensitive:
        data1: "oac_match_tempdata/univar.ster"
        data2: "oac_match_tempdata/multi1.ster"
        data3: "oac_match_tempdata/multi2.ster"
        data4: "oac_match_tempdata/multi3.ster"

  06c_an_models_ethnicity_af_match_positivecovidtest:
    run: stata-mp:latest analysis/06c_an_models_ethnicity.do positivecovidtest af_match
    needs: [02c_cr_create_population_af_match_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/06c_an_models_ethnicity_positivecovidtest.log
        table: "oac_match_tabfig/table3_positivecovidtest.txt"
      highly_sensitive:
        data1: "oac_match_tempdata/univar_ethn.ster"
        data2: "oac_match_tempdata/multivar1_ethn.ster"
        data3: "oac_match_tempdata/multivar2_ethn.ster"
        data4: "oac_match_tempdata/multivar2_withoutethn.ster"
        data5: "oac_match_tempdata/multivar3_ethn.ster"
        data6: "oac_match_tempdata/multivar3_withoutethn.ster"

  08c_an_model_checks_af_match_positivecovidtest:
    run: stata-mp:latest analysis/08c_an_model_checks.do positivecovidtest af_match
    needs: [02c_cr_create_population_af_match_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/08c_an_model_checks_positivecovidtest.log
        fig1: "oac_match_tabfig/schoenplot1.svg"
        fig2: "oac_match_tabfig/schoenplot2.svg"
        fig3: "oac_match_tabfig/schoenplot3.svg"
        fig4: "oac_match_tabfig/schoenplot4.svg"
        table1: "oac_match_tabfig/table5_positivecovidtest.txt"
        fig5: "oac_match_tabfig/schoenplot1_completecase.svg"
        fig6: "oac_match_tabfig/schoenplot2_completecase.svg"
        fig7: "oac_match_tabfig/schoenplot3_completecase_ethn.svg"
        fig8: "oac_match_tabfig/schoenplot3_completecase.svg"
        fig9: "oac_match_tabfig/schoenplot4_completecase_ethn.svg"
        fig10: "oac_match_tabfig/schoenplot4_completecase.svg"
        table2: "oac_match_tabfig/table6_positivecovidtest.txt"

  09a_an_models_plot_af_match_positivecovidtest:
    run: stata-mp:latest analysis/09a_an_models_plot.do positivecovidtest af_match
    needs: [02c_cr_create_population_af_match_positivecovidtest]
    outputs:
      moderately_sensitive:
        log: oac_match_log/09a_an_models_plot_positivecovidtest.log
        fig1: "oac_match_tabfig/adj_curves_positivecovidtest.svg"
        fig2: "oac_match_tabfig/diff_curves_positivecovidtest.svg"

  run_all:
    needs: [generate_cohort]
    # In order to be valid this action needs to define a run commmand and some
    # output. We don't really care what these are but the below does the trick.
    # In a future release of the platform, this special action won't need to be
    # defined at all.
    run: cohortextractor:latest --version
    outputs:
      moderately_sensitive:
        whatever: project.yaml
